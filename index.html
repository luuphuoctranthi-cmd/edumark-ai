<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EduMark AI - Chấm bài, Nhận xét và Chia sẻ</title>
  <!-- Tải Tailwind CSS để tạo giao diện đẹp và tương thích di động -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Tải Babel để xử lý JSX trong trình duyệt -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Tải React và ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  
  <!-- Tải KaTeX để hiển thị công thức toán học -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU0KOVEMGmONpbMBiZBHIhhpjHQL/TCpAaVvIFKcuYoVfI4dB2Ddiea" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" xintegrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>

</head>
<body class="bg-gray-100 font-sans">

  <div id="root"></div>

  <script type="text/babel">
    'use strict';

    // Hàm chuyển đổi file sang base64 để hiển thị preview và nhúng vào PDF
    const fileToBase64 = (file) => {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result); // Giữ nguyên data URL đầy đủ
        reader.onerror = (error) => reject(error);
      });
    };
    
    // Hàm chuyển đổi file sang base64 chỉ lấy phần dữ liệu để gửi cho API
    const fileToBase64ForApi = (file) => {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]); // Chỉ lấy phần dữ liệu sau dấu phẩy
        reader.onerror = (error) => reject(error);
      });
    };

    // API key đã được cung cấp
    const API_KEY = "AIzaSyALu1blNRFIB5VdwHeEzz0PWycaJZ5eONc";

    // Phản hồi mẫu chi tiết khi không có API Key, phù hợp nhiều môn học
    const getSampleResponse = () => {
        return `
### Chấm điểm
8.0/10

### Nhận xét
**Ưu điểm:**
- Bài làm có bố cục rõ ràng, luận điểm mạch lạc.
- Diễn đạt trôi chảy, sử dụng từ ngữ phong phú.

**Hạn chế:**
- Phần dẫn chứng còn chưa thực sự thuyết phục, thiếu số liệu hoặc ví dụ cụ thể.
- Kết luận hơi vội vàng, chưa tóm lược được hết các ý đã trình bày.

**Định hướng phát triển năng lực:**
- **Năng lực tư duy phản biện:** Cần rèn luyện cách tìm kiếm và đánh giá các nguồn thông tin để đưa ra dẫn chứng xác đáng.
- **Năng lực lập luận:** Cần củng cố kỹ năng tổng hợp thông tin để viết phần kết luận súc tích và bao quát hơn.

### Gợi ý Cải thiện
1.  **Thêm dẫn chứng cụ thể:** Với mỗi luận điểm, hãy tìm ít nhất một ví dụ, một số liệu, hoặc một trích dẫn từ nguồn uy tín để minh họa.
2.  **Viết lại phần kết luận:** Sau khi viết xong thân bài, hãy đọc lại và gạch ra các ý chính. Dựa vào đó để viết một đoạn kết luận mới, tóm tắt lại các luận điểm và khẳng định lại vấn đề.

### Bài tập Tương tự
1.  Phân tích một vấn đề xã hội bạn quan tâm, sử dụng ít nhất 3 nguồn dẫn chứng đáng tin cậy.
2.  Viết một đoạn văn ngắn tóm tắt nội dung của một bài báo hoặc một chương sách bạn vừa đọc.
3.  Chọn một câu danh ngôn bạn tâm đắc và viết một bài văn nghị luận về ý nghĩa của câu nói đó.
        `;
    };


    // Hàm gọi Gemini API
    async function callGeminiAPI(prompt, imageDatas = []) {
      if (!API_KEY) {
          console.log("Đang bỏ qua cuộc gọi API vì không có API Key. Sử dụng văn bản mẫu chi tiết.");
          return getSampleResponse();
      }
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
      const headers = { 'Content-Type': 'application/json' };
      
      const parts = [{ text: prompt }];
      if (imageDatas.length > 0) {
        imageDatas.forEach(imageData => {
            parts.push({
                inlineData: { mimeType: "image/png", data: imageData }
            });
        });
      }
      
      const payload = { contents: [{ role: 'user', parts: parts }] };
      
      try {
        const response = await fetch(url, { method: 'POST', headers: headers, body: JSON.stringify(payload) });
        if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
          return result.candidates[0].content.parts[0].text;
        } else {
          console.error("Lỗi: Cấu trúc phản hồi API không hợp lệ.", result);
          return "Không thể nhận được phản hồi từ AI. Vui lòng thử lại.";
        }
      } catch (error) {
        console.error("Lỗi khi gọi Gemini API:", error);
        return `Đã xảy ra lỗi: ${error.message}. Vui lòng thử lại sau.`;
      }
    }
    
    // Component để hiển thị nội dung có công thức toán
    const MathContent = ({ text }) => {
        const contentRef = React.useRef(null);
        React.useEffect(() => {
            if (contentRef.current && text && window.renderMathInElement) {
                // Thay thế \n bằng <br> để xuống dòng trong HTML
                contentRef.current.innerHTML = text.replace(/\n/g, '<br />');
                window.renderMathInElement(contentRef.current, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                    ],
                    throwOnError: false
                });
            } else if (contentRef.current) {
                contentRef.current.innerHTML = text.replace(/\n/g, '<br />');
            }
        }, [text]);

        if (!text) return null;
        
        return <div ref={contentRef} className="text-gray-700 leading-relaxed"></div>;
    };


    const App = () => {
      const [text, setText] = React.useState('');
      const [files, setFiles] = React.useState([]);
      const [filePreviews, setFilePreviews] = React.useState([]);
      const [grade, setGrade] = React.useState('Lớp 12');
      const [score, setScore] = React.useState('');
      const [feedback, setFeedback] = React.useState('');
      const [suggestion, setSuggestion] = React.useState('');
      const [similarExercises, setSimilarExercises] = React.useState('');
      const [isLoading, setIsLoading] = React.useState(false);
      const [isJsPdfLoaded, setIsJsPdfLoaded] = React.useState(false);
      const [copied, setCopied] = React.useState(false);
      const [apiKeyMissing] = React.useState(!API_KEY);
      const [shareUrl, setShareUrl] = React.useState('');

      React.useEffect(() => {
        const script = document.createElement('script');
        script.src = "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";
        script.async = true;
        script.onload = () => setIsJsPdfLoaded(true);
        script.onerror = () => console.error("Lỗi khi tải jsPDF.");
        document.body.appendChild(script);

        try {
            const params = new URLSearchParams(window.location.search);
            const data = params.get('data');
            if (data) {
                const decodedData = JSON.parse(atob(data));
                setText(decodedData.text || '');
                setGrade(decodedData.grade || 'Lớp 12');
                setScore(decodedData.score || '');
                setFeedback(decodedData.feedback || '');
                setSuggestion(decodedData.suggestion || '');
                setSimilarExercises(decodedData.similarExercises || '');
            }
        } catch (error) {
            console.error("Không thể đọc dữ liệu từ link chia sẻ:", error);
        }

        return () => { document.body.removeChild(script); };
      }, []);

      const getPromptContent = async () => {
        if (files.length > 0) {
          try {
            const imagePromises = files.map(file => fileToBase64ForApi(file));
            const imageDatas = await Promise.all(imagePromises);
            return { imageDatas: imageDatas, textContent: text };
          } catch (error) {
            setFeedback("Lỗi khi xử lý hình ảnh. Vui lòng thử lại.");
            return { imageDatas: null, textContent: null };
          }
        } else if (text) {
          return { imageDatas: [], textContent: text };
        }
        setFeedback("Vui lòng nhập văn bản hoặc tải ảnh bài làm.");
        return { imageDatas: null, textContent: null };
      };
      
      const handleComprehensiveGrade = async () => {
        setIsLoading(true);
        setScore(''); setFeedback(''); setSuggestion(''); setSimilarExercises('');
        
        const { imageDatas, textContent } = await getPromptContent();
        if ((!imageDatas || imageDatas.length === 0) && !textContent) { setIsLoading(false); return; }

        const prompt = `Bạn là một giáo viên ${grade} tận tâm. Dựa vào nội dung bài làm của học sinh, hãy tự xác định môn học và đưa ra phản hồi toàn diện, phù hợp với trình độ của ${grade}.
        Quan trọng: Nếu là môn Toán, Lý, Hóa, hãy sử dụng cú pháp LaTeX cho TẤT CẢ các công thức (ví dụ: dùng $ \\frac{1}{2} $ thay vì 1/2).
        Hãy trả lời theo đúng cấu trúc 4 phần sau, sử dụng Markdown heading:

        ### Chấm điểm
        (Ghi điểm số của bài làm trên thang điểm 10, ví dụ: 8.5/10)

        ### Nhận xét
        (Phân tích ưu điểm, hạn chế, và định hướng phát triển năng lực phù hợp với lứa tuổi ${grade}: tính toán, giải quyết vấn đề, tư duy logic, lập luận, sáng tạo...)

        ### Gợi ý Cải thiện
        (Đưa ra 2-3 gợi ý cụ thể, có thể hành động ngay để khắc phục lỗi sai, ngôn ngữ và độ khó phù hợp với ${grade})

        ### Bài tập Tương tự
        (Đưa ra 2-3 bài tập hoặc câu hỏi có dạng tương tự để học sinh luyện tập thêm, phù hợp với chương trình học của ${grade})
        `;

        const fullPrompt = `${prompt}\n\nBài làm của học sinh:\n"""\n${textContent || 'Học sinh nộp bài bằng hình ảnh.'}\n"""`;
        const result = await callGeminiAPI(fullPrompt, imageDatas);

        const scorePart = result.split('### Nhận xét')[0].replace('### Chấm điểm', '').trim();
        const feedbackPart = result.split('### Nhận xét')[1]?.split('### Gợi ý Cải thiện')[0].trim();
        const suggestionPart = result.split('### Gợi ý Cải thiện')[1]?.split('### Bài tập Tương tự')[0].trim();
        const exercisesPart = result.split('### Bài tập Tương tự')[1]?.trim();

        setScore(scorePart || "Chưa có điểm");
        setFeedback(feedbackPart || "Không có nhận xét.");
        setSuggestion(suggestionPart || "Không có gợi ý nào.");
        setSimilarExercises(exercisesPart || "Không có bài tập tương tự.");
        
        setIsLoading(false);
      };

      const handleFileChange = (e) => {
        if (e.target.files.length > 0) {
            const selectedFiles = Array.from(e.target.files);
            setFiles(selectedFiles);

            const filePromises = selectedFiles.map(file => fileToBase64(file));
            Promise.all(filePromises)
                .then(base64Files => { setFilePreviews(base64Files); })
                .catch(error => { console.error("Lỗi khi tạo preview ảnh:", error); });
        }
      };
      
      const handleDownloadFeedback = () => {
        if (isJsPdfLoaded && window.jspdf) {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
          doc.setFont('Roboto');
          let y = 20;
          const addText = (text, startY) => {
              if (!text) return startY;
              const lines = doc.splitTextToSize(text.replace(/(\*\*|###)/g, ''), 180);
              doc.text(lines, 10, startY);
              return startY + (lines.length * 6);
          }
          doc.text("PHIẾU CHẤM BÀI - EDUMARK AI", 105, 15, null, null, 'center');
          y = addText(`Khối lớp: ${grade}`, y+5);
          y = addText(`Điểm số: ${score}`, y);
          y = addText(`\nNội dung bài làm (nếu có):\n${text}`, y);
          y = addText(`\n\nNhận xét:\n${feedback}`, y);
          y = addText(`\n\nGợi ý cải thiện:\n${suggestion}`, y);
          y = addText(`\n\nBài tập tương tự:\n${similarExercises}`, y);

          if (filePreviews.length > 0) {
              filePreviews.forEach((imgData, index) => {
                  doc.addPage();
                  doc.text(`Hình ảnh bài làm của học sinh (${index + 1}/${filePreviews.length})`, 10, 15);
                  try {
                    const imgProps = doc.getImageProperties(imgData);
                    const pdfWidth = doc.internal.pageSize.getWidth();
                    const pageMargin = 20;
                    const imgWidth = pdfWidth - (pageMargin * 2);
                    const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
                    let imgY = 25;
                    doc.addImage(imgData, 'PNG', pageMargin, imgY, imgWidth, imgHeight);
                  } catch(e) {
                    console.error("Lỗi khi thêm ảnh vào PDF:", e);
                    doc.text("Không thể hiển thị hình ảnh này.", 10, 25);
                  }
              });
          }
          
          doc.save('Phieu-cham-bai-EduMark-AI.pdf');
        } else {
          alert("Lỗi: Thư viện tạo PDF chưa tải xong. Vui lòng thử lại sau giây lát.");
        }
      };

      const handleShare = () => {
          const dataToShare = { text, grade, score, feedback, suggestion, similarExercises };
          const encodedData = btoa(JSON.stringify(dataToShare));
          const baseUrl = window.location.href.split('?')[0];
          const url = `${baseUrl}?data=${encodedData}`;

          setShareUrl(url); // Luôn hiển thị link để người dùng có thể sao chép thủ công

          const textArea = document.createElement("textarea");
          textArea.value = url;
          textArea.style.position = "fixed";
          textArea.style.top = "-9999px"; // Di chuyển ra ngoài màn hình
          textArea.style.left = "-9999px";

          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();

          let successful = false;
          try { successful = document.execCommand('copy'); } 
          catch (err) { successful = false; }
          document.body.removeChild(textArea);

          if (successful) {
              setCopied(true);
              setTimeout(() => {
                  setCopied(false);
                  setShareUrl(''); // Xóa URL sau khi sao chép tự động thành công
              }, 2000);
          }
      };


      return (
        <div className="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4">
          <div className="w-full max-w-2xl bg-white rounded-xl shadow-2xl p-6 md:p-8 space-y-6">
            <div className="w-24 h-24 mx-auto mb-2">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="aiLogoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style={{stopColor: '#38bdf8'}} />
                            <stop offset="100%" style={{stopColor: '#a78bfa'}} />
                        </linearGradient>
                    </defs>
                    <path fill="url(#aiLogoGradient)" d="M17.82,2.09c-0.34-0.1-0.7-0.03-0.97,0.2c-0.69,0.59-0.62,1.69,0.14,2.15c2.39,1.44,4.02,3.95,4.02,6.56 c0,4.41-3.59,8-8,8s-8-3.59-8-8c0-2.61,1.63-5.12,4.02-6.56c0.76-0.46,0.84-1.56,0.14-2.15c-0.27-0.23-0.62-0.3-0.97-0.2 c-3.34,1-5.99,4.09-5.99,7.91c0,4.97,4.03,9,9,9s9-4.03,9-9C23.81,6.18,21.16,3.09,17.82,2.09z M12,14c-1.66,0-3-1.34-3-3s1.34-3,3-3 s3,1.34,3,3S13.66,14,12,14z M12,10c-0.55,0-1,0.45-1,1s0.45,1,1,1s1-0.45,1-1S12.55,10,12,10z"/>
                </svg>
            </div>
            <h1 className="text-3xl md:text-4xl font-extrabold text-center tracking-tight bg-gradient-to-r from-orange-500 to-red-500 bg-clip-text text-transparent">EduMark AI</h1>
            <p className="text-center text-blue-600 font-semibold text-xs md:text-sm -mt-2 italic">
                Tác giả: Trần Thị Lưu Phước - Trường TiH Lê Văn Tám - P.Tân Mỹ - TP.HCM
            </p>

            <textarea
              className="w-full h-40 md:h-52 p-4 text-gray-800 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-4 focus:ring-blue-500 focus:border-blue-500"
              placeholder="Dán hoặc nhập văn bản bài làm của học sinh vào đây..."
              value={text}
              onChange={(e) => setText(e.target.value)}
            />
            
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 items-center">
                <div className="w-full">
                    <label htmlFor="grade-select" className="block text-sm font-medium text-gray-700 mb-1">Chọn khối lớp:</label>
                    <select
                        id="grade-select"
                        value={grade}
                        onChange={(e) => setGrade(e.target.value)}
                        className="w-full p-3 border-2 border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                        {Array.from({ length: 12 }, (_, i) => i + 1).map(g => (
                        <option key={g} value={`Lớp ${g}`}>{`Lớp ${g}`}</option>
                        ))}
                    </select>
                </div>
                <label htmlFor="file-upload" className="w-full px-6 py-3 text-center text-white font-bold bg-green-500 rounded-full shadow-lg hover:bg-green-600 transition-all cursor-pointer mt-6 sm:mt-0">
                    <input id="file-upload" type="file" accept="image/*" className="hidden" multiple onChange={handleFileChange} />
                    {files.length > 0 ? `Đã chọn: ${files.length} ảnh` : "Tải ảnh bài làm"}
                </label>
            </div>

            <div className="border-t pt-6">
              <button
                onClick={handleComprehensiveGrade}
                disabled={isLoading}
                className="w-full px-6 py-4 text-white font-bold bg-blue-600 rounded-full shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all disabled:bg-gray-400 flex items-center justify-center text-lg"
              >
                {isLoading ? (
                    <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                ) : '✨ Chấm & Phản hồi Toàn diện ✨'}
              </button>
            </div>

            <div className="flex flex-col md:flex-row items-center justify-center gap-4 pt-4 border-t">
               <button onClick={handleShare} className="w-full md:w-auto px-8 py-3 text-white font-bold bg-teal-500 rounded-full shadow-lg hover:bg-teal-600">
                {copied ? '✅ Đã sao chép!' : '🔗 Tạo & Sao chép Link'}
              </button>
              <button onClick={handleDownloadFeedback} className="w-full md:w-auto px-8 py-3 text-white font-bold bg-gray-500 rounded-full shadow-lg hover:bg-gray-600">
                📥 Tải Phiếu Chấm Bài
              </button>
            </div>

            {shareUrl && !copied && (
                <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                    <p className="text-sm font-semibold text-red-700">Không thể tự động sao chép!</p>
                    <p className="text-xs text-red-600 mb-2">Vui lòng sao chép link dưới đây theo cách thủ công:</p>
                    <input 
                        type="text" 
                        readOnly 
                        value={shareUrl} 
                        className="w-full p-2 text-xs border rounded bg-gray-100 text-gray-700 focus:outline-none focus:ring-2 focus:ring-red-300" 
                        onFocus={e => e.target.select()} 
                    />
                </div>
            )}

            {/* Khu vực hiển thị kết quả */}
            {apiKeyMissing && !isLoading && (score || feedback) && (
                <div className="mt-6 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 rounded-lg" role="alert">
                    <p className="font-bold">Lưu ý: Đây là phản hồi mẫu</p>
                    <p>Do API Key chưa được cung cấp, ứng dụng chỉ hiển thị dữ liệu ví dụ. Khi có API Key, nhận xét sẽ thay đổi theo từng bài làm.</p>
                </div>
            )}

            {score && (
              <div className="mt-6 p-6 md:p-8 bg-yellow-50 rounded-lg shadow-inner border-l-4 border-yellow-400 text-center">
                <h2 className="text-2xl font-bold text-gray-800 mb-2">Điểm số</h2>
                <p className="text-4xl font-bold text-yellow-600">{score}</p>
              </div>
            )}
            {feedback && (
              <div className="mt-6 p-6 md:p-8 bg-blue-50 rounded-lg shadow-inner border-l-4 border-blue-400">
                <h2 className="text-2xl font-bold text-gray-800 mb-4">Nhận xét</h2>
                <MathContent text={feedback} />
              </div>
            )}
            {suggestion && (
              <div className="mt-6 p-6 md:p-8 bg-purple-50 rounded-lg shadow-inner border-l-4 border-purple-400">
                <h2 className="text-2xl font-bold text-gray-800 mb-4">Gợi ý Cải thiện</h2>
                 <MathContent text={suggestion} />
              </div>
            )}
            {similarExercises && (
              <div className="mt-6 p-6 md:p-8 bg-orange-50 rounded-lg shadow-inner border-l-4 border-orange-400">
                <h2 className="text-2xl font-bold text-gray-800 mb-4">Bài tập Tương tự</h2>
                 <MathContent text={similarExercises} />
              </div>
            )}
          </div>
        </div>
      );
    };

    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<App />);
  </script>

</body>
</html>
